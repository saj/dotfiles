#!/bin/bash

set -e

readonly SCRIPT="$(basename $0)"

TEMP=""

mktempdir() {
  TEMP="$(mktemp -d --tmpdir "${SCRIPT}.XXXXXX")"
}

rmtempdir() {
  rm -fr "${TEMP}"
}

cleanup() {
  rmtempdir
}

trap cleanup ERR EXIT

mktempdir

cd "${HOME}"
git archive --format=tar 'HEAD' >"${TEMP}/dotfiles.tar"
git submodule foreach --quiet --recursive \
  "git archive --format=tar --prefix=\"\${name}/\" 'HEAD' >\"${TEMP}/\${name//\\//-}.tar\""

find "${TEMP}" -mindepth 1 -maxdepth 1 -type f -name '*.tar' \
  | grep -v 'dotfiles.tar' \
  | xargs tar --file="${TEMP}/dotfiles.tar" --concatenate

cat "${TEMP}/dotfiles.tar"
