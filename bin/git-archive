#!/bin/bash

# Export a Git repo and all submodules to an uncompressed tarball on stdout.

set -u
set -o pipefail

readonly SCRIPT_NAME="${0##*/}"

readonly ARCHIVE='superproject.tar'

TMPDIR=""
REPO="${1:-${HOME}}"; shift

# TODO: Make recursion work for values other than HEAD.
#REVISION="${1:-'HEAD'}"

trap cleanup ERR EXIT

cleanup() {
  local -r rv=$?
  cd "${REPO}"
  [[ -n "${TMPDIR}" ]] && rm -r "${TMPDIR}"
  return $rv
}

TMPDIR="$(mktemp -d --tmpdir "${SCRIPT_NAME}.XXXXXX")"

cd "${TMPDIR}"

(
  cd "${REPO}" || exit

  git archive --format=tar 'HEAD' >"${TMPDIR}/${ARCHIVE}"

  git submodule foreach --quiet --recursive \
      "git archive --format=tar --prefix=\"\${name}/\" 'HEAD' >\"${TMPDIR}/\${name//\\//-}.tar\""
)

find "${TMPDIR}" -mindepth 1 -maxdepth 1 -type f \
    -name '*.tar' \! -name "${ARCHIVE}" -print0 | \
    xargs -0 tar -f "${TMPDIR}/${ARCHIVE}" --concatenate

cat "${TMPDIR}/${ARCHIVE}"
